<!DOCTYPE html>
<html>
<head>
    <title>Razorpay Payment Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #3399cc;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3399cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .response-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            min-height: 100px;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Razorpay Payment Test</h1>
        
        <!-- Amount Input -->
        <div class="form-group">
            <label for="amount">Amount (INR):</label>
            <input type="number" id="amount" value="100" min="1" max="10000">
        </div>
        
        <!-- JWT Token Input -->
        <div class="form-group">
            <label for="jwtToken">JWT Token:</label>
            <input type="text" id="jwtToken" placeholder="Enter your JWT token">
        </div>
        
        <!-- Pay Button -->
        <button id="pay-button">Make Payment</button>
        
        <!-- Status Area -->
        <div class="status" id="status-area"></div>
        
        <!-- Response Area -->
        <h3>Response:</h3>
        <div class="response-area" id="response-area">
            <p>Response will appear here...</p>
        </div>
    </div>
    
    <script>
        document.getElementById('pay-button').onclick = function() {
            const amount = document.getElementById('amount').value;
            const jwtToken = document.getElementById('jwtToken').value;
            const statusArea = document.getElementById('status-area');
            const responseArea = document.getElementById('response-area');
            
            // Clear previous statuses
            statusArea.className = 'status';
            statusArea.textContent = 'Creating order...';
            
            // First call your backend to create an order
            fetch(`http://localhost/api/payment-gateway/create-order?amount=${amount}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.text();
            })
            .then(data => {
                responseArea.innerHTML = '<strong>Order Created:</strong><br>' + data;
                
                try {
                    const orderData = JSON.parse(data);
                    statusArea.textContent = 'Order created successfully. Opening payment form...';
                    
                    const options = {
                        key: 'rzp_test_0EQMDqroOyLvid', // Replace with your actual Razorpay test key
                        amount: orderData.amount,
                        currency: orderData.currency,
                        name: 'Test Company',
                        description: 'Test Transaction',
                        order_id: orderData.id,
                        handler: function (response) {
                            statusArea.textContent = 'Payment completed. Verifying...';
                            
                            // Call your backend to verify the payment
                            fetch(`http://localhost/api/payment-gateway/verify?orderId=${response.razorpay_order_id}&paymentId=${response.razorpay_payment_id}&signature=${response.razorpay_signature}`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${jwtToken}` // Include the JWT token in the header
                                }
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Verification request failed: ' + response.statusText);
                                }
                                return response.text();
                            })
                            .then(verifyData => {
                                if (verifyData === 'Payment Verified and User Marked as Premium') {
                                    statusArea.className = 'status success';
                                    statusArea.textContent = 'Payment verified and user marked as premium!';
                                } else {
                                    statusArea.className = 'status error';
                                    statusArea.textContent = 'Payment verification failed!';
                                }
                                
                                responseArea.innerHTML += '<br><br><strong>Verification Result:</strong><br>' + verifyData;
                                responseArea.innerHTML += '<br><br><strong>Payment Details:</strong><br>' + 
                                                        'Order ID: ' + response.razorpay_order_id + '<br>' +
                                                        'Payment ID: ' + response.razorpay_payment_id + '<br>' +
                                                        'Signature: ' + response.razorpay_signature;
                            })
                            .catch(error => {
                                statusArea.className = 'status error';
                                statusArea.textContent = 'Verification Error: ' + error.message;
                                console.error('Verification Error:', error);
                            });
                        },
                        prefill: {
                            name: 'Test User',
                            email: 'test@example.com',
                            contact: '9999999999'
                        },
                        notes: {
                            address: 'Test Address'
                        },
                        theme: {
                            color: '#3399cc'
                        }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.on('payment.failed', function (response){
                        statusArea.className = 'status error';
                        statusArea.textContent = 'Payment failed';
                        responseArea.innerHTML += '<br><br><strong>Payment Failed:</strong><br>' +
                                                'Error Code: ' + response.error.code + '<br>' +
                                                'Error Description: ' + response.error.description + '<br>' +
                                                'Error Source: ' + response.error.source + '<br>' +
                                                'Error Step: ' + response.error.step + '<br>' +
                                                'Error Reason: ' + response.error.reason;
                    });
                    
                    rzp.open();
                } catch (e) {
                    statusArea.className = 'status error';
                    statusArea.textContent = 'Error parsing order data: ' + e.message;
                    console.error('Error parsing order data:', e);
                }
            })
            .catch(error => {
                statusArea.className = 'status error';
                statusArea.textContent = 'Error creating order: ' + error.message;
                responseArea.textContent = 'Error: ' + error.message;
                console.error('Error:', error);
            });
        };
    </script>
</body>
</html>